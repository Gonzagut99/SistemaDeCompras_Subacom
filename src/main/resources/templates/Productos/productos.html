<!DOCTYPE html>
<html lang="es"  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link href="../static/input.css" rel="stylesheet"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/flowbite.min.css"  rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                clifford: '#da373d',
              }
            }
          }
        }
      </script>
    <style type="text/tailwindcss">
        @layer utilities {
          .content-auto {
            content-visibility: auto;
          }
        }
    </style>
    <title>Página Necesidades - Proyecto Subacom DMS</title>
</head>
<body class="bg-gray-700 flex flex-col min-h-screen">
    <nav th:insert="homeTemplate.html :: nav"></nav>
  <main class="pt-[92px] px-5 pb-4 flex flex-col items-center"> 
    <div class="max-w-screen-xl flex flex-col w-full ">
        <!-- Title and Breadcrumb -->
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a th:href="@{/home}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                <svg class="w-3 h-3 mr-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                </svg>
                Inicio
                </a>
            </li>
            <!-- <li>
                <div class="flex items-center">
                <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <a href="#" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2 dark:text-gray-400 dark:hover:text-white">Empleados</a>
                </div>
            </li> -->
            <li aria-current="page">
                <div class="flex items-center">
                <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">Productos</span>
                </div>
            </li>
            </ol>
        </nav>

        <!-- Main heading -->
        <div class="flex flex-wrap justify-between items-start">
            <h2 class="mb-4 text-5xl font-extrabold text-gray-900 dark:text-white md:text-5xl lg:text-5xl"><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-blue-600">Productos</span></h2>
            <a th:href="@{/producto}"><button type="button" class="h-12 text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-base px-5 py-3 text-center">Añadir nuevo Producto</button></a>
          </div>
        
        <section class="mb-8">
            <!-- subtitle -->
            <h5 class="text-xl font-bold dark:text-white mb-3">Selecciona los productos para tu pedido</h5>
            <h6 class="text-md font-bold dark:text-white mb-3">Primero aumenta la cantidad</h6>

            <!-- datepicker input -->
            <!-- <div class="w-full md:min-w-[280px] md:w-[300px] lg:w-1/4 mb-4">
                <label for="text" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha tentativa de compra:</label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                    </svg>
                  </div>
                  <input datepicker type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Seleccionar fecha">
                </div>
              </div> -->

            <!-- checkboxTable products -->
            <form th:action="@{/registrarpedido}" method="post" th:object="${pedido}" id="productosSeleccionadosForm" class="relative overflow-x-auto shadow-md pb-4">
                <div class="border-2 dark:border-gray-600 rounded-lg overflow-x-auto">
                    <table class="rounded-lg w-full text-sm text-left text-gray-500 dark:text-gray-400 ">
                        <thead class="rounded-t-lg text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="p-4">
                                    <div class="flex items-center">
                                        <input id="checkbox-all-search" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                        <label for="checkbox-all-search" class="sr-only">checkbox</label>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    ID producto
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    <span class="sr-only">Image</span>
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Producto
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Categoría
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Precio unidad
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Cantidad
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Precio Total
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tablaCheckbox" class="rounded-b-lg">
                            <tr th:each="producto:${productos}" th:attr="producto.unit_price=${producto.unit_price}, producto.product_stock=${producto.product_stock}, producto.id_product=${producto.id_product}"  class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <td class="w-4 p-4">
                                    <div class="flex items-center">
                                        <input th:id="${producto.id_product}" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                        <label th:for="${producto.id_product}" class="sr-only">checkbox</label>
                                    </div>
                                </td>
                                <th th:text="${producto.id_product}" th:value="${producto.id_product}" scope="row" class=" w-20 px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                    PO-001
                                </th>
                                <td class="w-32 p-4">
                                    <img th:src="${producto.product_photo_url}" th:alt="${producto.product_name}">
                                </td>
                                <td class="px-6 py-4" th:text="${producto.product_name}">
                                    Apple MacBook Pro 17"
                                </td>
                                <td class="px-6 py-4" th:text="${producto.categoria.category_name}">
                                    Ordenadores
                                </td>
                                <td class="px-6 py-4" >
                                    S/. <span th:text="${producto.unit_price}">2999</span>
                                </td>
                                <td class="px-6 py-4 w-[200px]">
                                    <div class="flex items-center space-x-3">
                                        <button class="inline-flex items-center justify-center p-1 text-sm font-medium h-6 w-6 text-gray-500 bg-white border border-gray-300 rounded-full focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700" type="button">
                                            <span class="sr-only">Quantity button</span>
                                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 2">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h16"/>
                                            </svg>
                                        </button>
                                        <div class="inputQuantity">
                                            <input type="number" name="quantity_product" class="bg-gray-50 w-14 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-2.5 py-1 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="0" value="0" th:attr="min=${0}, max=${producto.product_stock}" required>
                                        </div>
                                        <button class="inline-flex items-center justify-center h-6 w-6 p-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-full focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700" type="button">
                                            <span class="sr-only">Quantity button</span>
                                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td class="px-6 py-4 font-semibold text-gray-900 dark:text-white">
                                    <span>S/.</span> <span id="precio_total_unitario" th:text="${0.00}">2999</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav class="flex items-center justify-between pt-4" aria-label="Table navigation">
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Mostrando <span th:text="${page.numberOfElements}" class="font-semibold text-gray-900 dark:text-white">5</span> de <span th:text="${page.totalElements}" class="font-semibold text-gray-900 dark:text-white">1000</span></span>
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Página <span th:text="${currentPage + 1}">1</span> de <span th:text="${totalPages}">100</span></span>
                    <ul class="inline-flex -space-x-px text-sm h-8">
                        <li>
                            <a th:href="@{/productos(page=${currentPage - 1}, size=${page.size})}" th:if="${currentPage > 0}" class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Anterior</a>
                        </li>
                        <li th:each="pageNumber : ${#numbers.sequence(0, totalPages - 1)}">
                            <a th:href="@{/productos(page=${pageNumber}, size=${page.size})}" th:text="${pageNumber + 1}" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</a>
                        </li>
                        <li>
                            <a th:href="@{/productos(page=${currentPage + 1}, size=${page.size})}" th:if="${currentPage < totalPages - 1}" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Siguiente</a>
                        </li>
                    </ul>
                </nav>
                <!-- Select proveedor -->
                <div class="mt-5 mb-6 w-full md:min-w-[280px] md:w-[300px] lg:w-1/4">
                    <label for="proveedor_input" class="block w-full mb-2 text-sm font-medium text-gray-900 dark:text-white">Proveedor:</label>
                    <select id="proveedor_input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                        <option th:each="proveedor,stat: ${proveedores}" th:value="${proveedor.id_supplier}" th:text="${proveedor.supplier_name}" th:selected="${stat.index == 0}">Hola</option>
                    </select>
                </div>

                <div class=" flex gap-6 w-full justify-end items-center mt-4">
                    <div class="dark:text-gray-400 text-lg">Productos seleccionados: <span id="productosSeleccionadosSpan" class="text-gray-900 dark:text-white">1</span></div>
                    <div class="dark:text-gray-400 text-lg">Precio total: <span class="text-gray-900 dark:text-white">S/.</span> <span id="precioTotalSpan" class="text-gray-900 dark:text-white">2999</span></div>
                    <button type="submit" class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-base px-5 py-3 text-center">Pedir productos seleccionados</button>
                </div>
            </form>
            <script th:inline="javascript">
                    let productosSeleccionados = JSON.parse(sessionStorage.getItem('productosSeleccionados')) || [];
                    console.log(productosSeleccionados)
                    
                    const productosSeleccionadosSpan = document.getElementById('productosSeleccionadosSpan');
                    const precioTotalSpan = document.getElementById('precioTotalSpan');
                
                    // Busca todos los elementos tr en el cuerpo de la tabla
                    let filas = document.querySelectorAll('#tablaCheckbox tr');
                    const formulario = document.querySelector('#productosSeleccionadosForm');

                    let actualizarTotales = ()=>{
                        if (productosSeleccionados.length>0) {
                            fetch('http://localhost:8095/subacomcompras/productosrest')
                            .then(res => res.json())
                            .then(data=>{
                                let precios = []
                                productosSeleccionados.forEach(prod=>{
                                    const productoEncontrado=data.find((ele)=>{
                                        return ele.id_product==prod.id_product
                                    });

                                    precios.push(parseFloat((productoEncontrado.unit_price*parseInt(prod.quantity)).toFixed(2)))
                                })
                                console.log(precios);
                                productosSeleccionadosSpan.textContent=productosSeleccionados.length;
                                precioTotalSpan.textContent=(precios.reduce((a,b)=>a+b)).toFixed(2)                               
                            })
                            .catch(e=>console.log(e))
                        }else{
                            productosSeleccionadosSpan.textContent=0;
                            precioTotalSpan.textContent='0.0';
                        }
                    }

                    actualizarTotales();
                
                    filas.forEach(function(fila) {
                        // Busca el checkbox y el input en esta fila
                        const checkbox = fila.querySelector('input[type="checkbox"]');
                        const inputQuantity = fila.querySelector('.inputQuantity input[type="number"]');
                        const thId = fila.querySelector('th');
                        const botonMenos = fila.querySelector('button:first-of-type');
                        const botonMas = fila.querySelector('button:last-of-type');
                        const tdPrecioTotal = fila.querySelector('td:last-of-type #precio_total_unitario');
                        const id_product = fila.getAttribute('producto.id_product');


                        //Busca coincidencias entre la tabla producto y los productos seleccionados de sessionStorage
                        const productoEncontrado = productosSeleccionados.find((producto)=> producto.id_product === id_product);

                        //Se marca como true el checkbox, el precio y la cantidad
                        if (productoEncontrado) {
                            checkbox.checked = true;
                            tdPrecioTotal.textContent = productoEncontrado.precio_compra;
                            inputQuantity.value = productoEncontrado.quantity;
                        }
                        
                        let actualizarPrecioUnitario=(valor)=>{
                            let precioUnitario = parseFloat(fila.getAttribute('producto.unit_price'));
                            tdPrecioTotal.textContent = (precioUnitario * valor).toFixed(2);
                            
                        }

                        // Cuando el estado del checkbox cambia
                        checkbox.addEventListener('change', function() {
                            if (checkbox.checked) {
                                // Si el checkbox está seleccionado, añade el id_product y el valor del input a la lista de productos seleccionados                               
                                if (productoEncontrado) {                           
                                    productoEncontrado.id_product = thId.textContent;
                                    productoEncontrado.quantity = inputQuantity.value;
                                }else{
                                    productosSeleccionados.push({
                                    id_product: thId.textContent,
                                    quantity: inputQuantity.value,
                                    precio_compra: parseFloat(tdPrecioTotal.textContent) 
                                });
                                }
                                
                            } else {
                                // Si el checkbox no está seleccionado, elimina el producto de la lista de productos seleccionados
                                productosSeleccionados = productosSeleccionados.filter(function(producto) {
                                    return producto.id_product !== thId.textContent;
                                });
                            }
                            // Guarda productosSeleccionados en el almacenamiento local
                            sessionStorage.setItem('productosSeleccionados', JSON.stringify(productosSeleccionados));
                            console.log(productosSeleccionados);
                            actualizarTotales();
                        });
                        inputQuantity.addEventListener('change',(event)=>{
                            let valor = event.target.value
                            if (valor === '' || valor === undefined || valor === null) {
                                inputQuantity.value = 0;
                            }
                            // Actualiza el precio total
                            actualizarPrecioUnitario(valor)
                        })

                        // Cuando se hace clic en el botón menos
                        botonMenos.addEventListener('click', function() {
                            // Disminuye el valor del input, pero no menos de 0
                            let valor = Math.max(parseInt(inputQuantity.value) - 1, 0);
                            inputQuantity.value = valor;

                            // Actualiza el precio total
                            actualizarPrecioUnitario(valor)
                        });

                        // Cuando se hace clic en el botón más
                        botonMas.addEventListener('click', function() {
                            // Aumenta el valor del input, pero no más que el stock del producto
                            let stock = parseInt(fila.getAttribute('producto.product_stock'));
                            let valor = Math.min(parseInt(inputQuantity.value) + 1, stock);
                            inputQuantity.value = valor;

                            // Actualiza el precio total
                            actualizarPrecioUnitario(valor)
                        });
                        
                    });
                    
                    formulario.addEventListener('submit', function(event) {
                        // Evita que se envíe el formulario
                        event.preventDefault();

                        // Obtén la lista de objetos de tu almacenamiento de sesión
                        //var listaObjetos = JSON.parse(sessionStorage.getItem("tuLista"));

                        //input del proveedor
                        let proveedor_inputValue = ((document.getElementById('proveedor_input')).value);
                        let id_employee= sessionStorage.getItem("id_employee");

                        // Envía la lista completa al controlador usando Fetch
                        fetch('http://localhost:8095/subacomcompras/pedidoRest/listaPedidoDetail', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(productosSeleccionados), // Convierte la lista completa a una cadena JSON
                        })
                        .then(response => response.text())
                        .then(data => {
                            console.log(data)
                            fetch(`http://localhost:8095/subacomcompras/pedidoRest/registrarpedidoRest?id_proveedor=${proveedor_inputValue.toString()}&id_employee=${id_employee.toString()}`,
                                {
                                    method: 'POST'
                                }
                            )
                            .then(res=>res.text())
                            .then(data2=>console.log(data))
                            .catch(err=>console.log(err))
                        })
                        .catch((error) => {
                            console.log(error)
                        });

                        setTimeout(()=>{
                            // Elimina el ítem de sessionStorage
                            sessionStorage.removeItem('productosSeleccionados');

                            // Aquí puedes hacer lo que necesites después de eliminar el ítem
                            actualizarTotales();
                        },2000)
                        
                    });
                </script>
                
        </section>
    </div>
  </main>
    
  <footer class="bg-white rounded-lg shadow m-4 dark:bg-gray-800 mt-auto">
    <div class="w-full mx-auto max-w-screen-xl p-4 md:flex md:items-center md:justify-between">
      <span class="text-sm text-gray-500 sm:text-center dark:text-gray-400">© 2023 <a href="https://flowbite.com/" class="hover:underline">Subacom™</a>. Diseñado por @GonzaloGutierrez
    </span>
    <ul class="flex flex-wrap items-center mt-3 text-sm font-medium text-gray-500 dark:text-gray-400 sm:mt-0">
        <li>
            <a href="#" class="hover:underline">Contacto</a>
        </li>
    </ul>
    </div>
  </footer>

  <!-- flowbite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/flowbite.min.js"></script>
  <script src="../../static/js/empleado.js"></script>
  <script src="../../static/js/components/navbar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/datepicker.min.js"></script>
</body>
</html>